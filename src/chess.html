<html>
  <head>
    <title>Chess</title>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link type="text/css" href="css/custom-theme/jquery-ui-1.7.2.custom.css" rel="stylesheet" />  
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.min.js"></script>
    <style>
      .board {width: 800px; height: 800px; border: 2px solid darkgrey; position: relative;}
      .square {float: left;}
      /*.wsq {background-color: lightgrey;}*/
      .wsq {background-image:url('images/white-marble.jpg');}
      /*.bsq {background-color: grey;}*/
      .bsq {background-image:url('images/grey-marble.jpg');}
      .dropper {background-color: yellow; background-image: none}
      .piece {position: absolute;}
      /*.wpc {background-color: white; color: black;}*/
      /*.bpc {background-color: black; color: white;}*/
    </style>
    <script>
      $(function() {
        var invert = false;
        var whiteMove = true;
        var board = $('.board');
        var boardData = [];
        var w = board.width(), h = board.height(), sw = w / 8, sh = h / 8, square;

        // we've already eliminated:
        //  - white move on black's turn and vice versa
        //  - move from and to same square
        //  - taking your own peices
        function legalMove(sourceSquare, targetSquare, piece) {
            var isWhite = piece.hasClass('wpc'),
              sx = sourceSquare.data('x'), 
              sy = sourceSquare.data('y'),
              tx = targetSquare.data('x'),
              ty = targetSquare.data('y');
            if(piece.hasClass('rook')) {
                if(sx != tx && sy != ty)
                    return false;
                for(var x = sx + (tx > sx ? 1 : -1); x != tx; x = x + (tx > sx ? 1 : -1))
                  if(boardData[x][sy].data('piece')) return false;
                for(var y = sy + (ty > sy ? 1 : -1); y != ty; y = y + (ty > sy ? 1 : -1))
                    if(boardData[x][sy].data('piece')) return false;
            }    
            return true;
        }
        
        function makePiece(x, y, isWhite, typ, square) {
          var img = ('<img src="images/' + (isWhite ? 'paper' : 'cloth') + '-' + typ + '.png" width="' + (sw) + '" height="' + (sh) + '"/>');
          var piece = $('<div class="piece ' + (isWhite ? 'wpc' : 'bpc') + ' ' + typ + '"/>')
            .css('width', '' + sw + 'px')
            .css('height', '' + sh + 'px')
            .css('left', '' + (x * sw) + 'px')
            .css('top', '' + (y * sh) + 'px')
            .data('square', square)
            .data('startY', y)
            .append(img);
          board.append(piece);
          // must be done after adding to board, or the position becomes relative?!?!
          piece.draggable({   containment: 'parent', 
                              stack: { group: '.piece', min: 1 },
                              revert: 'invalid' });
          return piece;
        }
          
        var types = ['rook', 'knight', 'bishop', 'queen', 'king', 'bishop', 'knight', 'rook'];

        for(var x = 0; x < 8; x++) {
          boardData[x] = [];
          for(var y = 0; y < 8; y++) {
            square = $('<div class="square ' + ((y + x) % 2 ? 'bsq' : 'wsq') + '"/>')
              .css('width', '' + sw + 'px')
              .css('height', '' + sh + 'px')
              .data('x', x)
              .data('y', y)
              .droppable({
                accept: function(piece) {
                    if(piece.hasClass('wpc') != whiteMove) return false;
                    var square = $(this), sourceSquare = piece.data('square');
                    if(square.data('x') == sourceSquare.data('x') && square.data('y') == sourceSquare.data('y'))
                        return false;
                    var targetPiece = square.data('piece');
                    if (targetPiece && (targetPiece.hasClass('wpc') == piece.hasClass('wpc')))
                        return false;
                    return legalMove(sourceSquare, square, piece);  
                  },
                hoverClass: 'dropper',
                cursor: 'pointer',
                drop: function(event, ui) {
                  var targetSquare = $(this),
                    piece = ui.draggable,
                    sourceSquare = piece.data('square');

                  sourceSquare.removeData('piece');

                  /////////// move
                  var targetPiece = targetSquare.data('piece');
                  if(targetPiece) targetPiece.remove();

                  targetSquare.data('piece', piece);
                  piece.data('square', targetSquare);

                  //promote pawns
                  if(piece.hasClass('pawn') && Math.abs(piece.data('startY') - targetSquare.data('y')) == 6) {
                    var isWhite = piece.hasClass('wpc');
                    piece.removeClass('pawn').addClass('queen')
                      .html('<img src="images/' + (isWhite ? 'paper' : 'cloth') + '-queen.png" width="' + (sw) + '" height="' + (sh) + '"/>');
                  }

                  whiteMove = !whiteMove;
                  /////////////////

                  piece
                    .css('left', '' + event.target.offsetLeft + 'px')
                    .css('top', '' + event.target.offsetTop + 'px');
                }
              });
            board.append(square);
            boardData[x][y] = square;
            
            var piece;
            if(y == 0 || y == 7) {
              var typ = types[invert ? (7 - x) : x];
              if(y == 0) piece = makePiece(x, 0, invert, typ, square);
              if(y == 7) piece = makePiece(x, 7, !invert, typ, square);
            }
            else if(y == 1) piece = makePiece(x, 1, invert, 'pawn', square);
            else if(y == 6) piece = makePiece(x, 6, !invert, 'pawn', square);
            else piece = null;
          }
        }
        
      });
    </script>
  </head>
  <body>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js"></script>
  <script>CFInstall.check({mode: "overlay"});</script>  
  <center>
    <div></div>
    <div class='board'>
    </div>
  </center>
  </body>
</html>